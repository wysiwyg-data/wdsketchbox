/**
 * wdSketchBox Plug-In 1.0
 *
 * File: wdSketchBox.js
 *
 * Inspired from:
 * http://github.com/crowdsavings/drawbox       -> no longer active
 *
 * @author     WYSIWYG Data development
 * @copyright  (c) 2024 WYSIWYG Data
 */
class wdSketchBox{constructor({drawElement:t="",drawElementHeight:e=100,drawElementWidth:i=100,saveElement:s="",loadImg:o=!1,iconPath:c="",iconPencilIdle:n="icon_pencil.png",iconPencilSel:h="icon_pencil_picked.png",iconEraserIdle:a="icon_eraser.png",iconEraserSel:r="icon_eraser_picked.png",strokeWidth:l=1,strokeOpacity:d=1,strokeColour:m="black",strokeCap:u="round",strokeJoin:v="round",miterLimit:g=10,fillStyle:S="none",shadowOffsetX:C=0,shadowOffsetY:w=0,shadowBlur:p=0,shadowColor:x="none"}){""==t||""==s?(this.cContext=null,alert("A valid <canvas> element id AND a valid <input> element id (for saving) must be provided.\nwdSketchBox cannot proceed!")):(this.cDrawElement=t,this.cSaveElement=document.getElementById(s),this.cLoadImg=o,this.cIconPath=c,this.cIconPencilIdle=n,this.cIconPencilSel=h,this.cIconEraserIdle=a,this.cIconEraserSel=r,this.cStrokeWidth=l,this.cStrokeOpacity=d,this.cStrokeColour=m,this.cStrokeCap=u,this.cStrokeJoin=v,this.cMiterLimit=g,this.cFillStyle=S,this.cShadowOffsetX=C,this.cShadowOffsetY=w,this.cShadowBlur=p,this.cShadowColor=x,this.cCanvas=document.getElementById(this.cDrawElement),this.cContext=this.cCanvas.getContext("2d"),this.cDrawing=!1,this.cInside=!1,this.cScrollLeft=0,this.cScrollTop=0,this.cPrevX=!1,this.cPrevY=!1,this.x=!1,this.y=!1,this.cOffset=this.elementOffset(this.cCanvas),this.cHeight=e,this.cWidth=i,this.elementSize(this.cCanvas),this.cMode="pencil")}get wd_SketchBox(){try{if(null!==this.cContext){1==this.cCanvas.hasAttribute("onclick")&&this.cCanvas.removeAttribute("onclick"),this.cCanvas.style.cursor="crosshair",this.pickedColour(this.cStrokeColour),document.getElementById("wd_SkBxPencilImg").setAttribute("src",this.cIconPath+this.cIconPencilSel),this.cContext.underInteractionEnabled=!0,this.cContext.loadImg=this.cLoadImg,this.cContext.lineWidth=this.cStrokeWidth,this.cContext.lineCap=this.cStrokeCap,this.cContext.lineJoin=this.cStrokeJoin,this.cContext.miterLimit=this.cMiterLimit,this.cContext.strokeStyle=this.cStrokeColour,this.cContext.fillStyle=this.cFillStyle,this.cContext.shadowOffsetX=this.cShadowOffsetX,this.cContext.shadowOffsetY=this.cShadowOffsetY,this.cContext.shadowBlur=this.cShadowBlur,this.cContext.shadowColor=this.cShadowColor,this.cContext.globalAlpha=this.cStrokeOpacity,1==this.cLoadImg&&this.loadSavedImage(this.cContext),this.cCanvas.addEventListener("mousedown",(t=>{this.drawingStart(this.cCanvas,t,this.cContext)})),this.cCanvas.addEventListener("mousemove",(t=>{this.drawingMove(this.cCanvas,t,this.cContext)})),this.cCanvas.addEventListener("mouseup",(t=>{this.drawingStop(this.cCanvas,t,this.cContext)})),this.cCanvas.addEventListener("contextmenu",(t=>{this.drawingStop(this.cCanvas,t,this.cContext)}));for(var t=document.querySelectorAll(".wd_SkBxColour"),e=0;e<t.length;e++)t[e].addEventListener("click",(e=>{for(var i=0;i<t.length;i++)t[i].style.borderColor="transparent";var s=e.target.dataset.colour;this.cContext.strokeStyle=s,this.pickedColour(s)}));document.getElementById("wd_SkBxToolPencil").addEventListener("click",(t=>{this.cMode="pencil",this.clearToolHilite(this.cIconPath),document.getElementById("wd_SkBxPencilImg").setAttribute("src",this.cIconPath+this.cIconPencilSel)})),document.getElementById("wd_SkBxToolEraser").addEventListener("click",(t=>{this.cMode="eraser",this.clearToolHilite(this.cIconPath),document.getElementById("wd_SkBxEraserImg").setAttribute("src",this.cIconPath+this.cIconEraserSel)})),document.getElementById("wd_SkBxToolClear").addEventListener("click",(t=>{this.cContext.save(),this.cContext.beginPath(),this.cContext.closePath(),this.cContext.restore(),this.cContext.clearRect(0,0,this.cWidth,this.cHeight)})),document.getElementById("wd_SkBxToolSave").addEventListener("click",(t=>{this.cSaveElement.value=this.cCanvas.toDataURL("image/png")}));var i=document.getElementById("bc_StrokeSize");i.addEventListener("input",(t=>{document.getElementById("wd_StrokeSizeSpan").textContent=i.value+"px",this.cContext.lineWidth=i.value}));var s=document.getElementById("bc_StrokeOpacity");s.addEventListener("input",(t=>{document.getElementById("wd_strokeOpacitySpan").textContent=100*Number(s.value)+"%",this.cContext.globalAlpha=s.value}))}}catch(t){alert(t)}}get wd_SkBxSave(){try{this.cSaveElement.value=this.cCanvas.toDataURL("image/png")}catch(t){console.log(t)}}loadSavedImage(t){t.clearRect(0,0,this.cWidth,this.cHeight);var e=new Image;e.src=this.cSaveElement.value,e.onload=function(){t.drawImage(e,0,0)}}clearToolHilite(t){document.getElementById("wd_SkBxPencilImg").setAttribute("src",t+this.cIconPencilIdle),document.getElementById("wd_SkBxEraserImg").setAttribute("src",t+this.cIconEraserIdle)}trackPosition(t,e){0!=this.x&&(this.cPrevX=this.x,this.cPrevY=this.y);var i=this.elementOffset(t);return this.x=e.pageX-i.left,this.y=e.pageY-i.top,e}doDraw(t,e){"stop"!=t?("pencil"==this.cMode?e.globalCompositeOperation="source-over":"eraser"==this.cMode&&(e.globalCompositeOperation="destination-out"),"start"==t?(this.cInside=!1,this.cPrevX=!1,this.cPrevY=!1,e.beginPath(),e.moveTo(this.x,this.y)):(0==this.cPrevX&&(this.x=this.x+1,this.y=this.y+1),e.lineTo(this.x,this.y)),e.stroke(),this.x>0&&this.x<=this.cWidth&&this.y>0&&this.y<=this.cHeight&&(this.cInside=!0)):this.doDraw("move",e)}drawingStart(t,e,i){1==this.cInside&&e.preventDefault(),this.cDrawing=!0,e=this.trackPosition(t,e),this.doDraw("start",i)}drawingMove(t,e,i){return 1==this.cInside&&e.preventDefault(),1==this.cDrawing&&(e=this.trackPosition(t,e),this.doDraw("move",i)),!1}drawingStop(t,e,i){this.cDrawing=!1,this.doDraw("stop",i)}elementSize(t){t.setAttribute("width",800),t.setAttribute("height",600)}elementOffset(t){var e=t.getBoundingClientRect();return this.cScrollLeft=window.pageXOffset||document.documentElement.scrollLeft,this.cScrollTop=window.pageYOffset||document.documentElement.scrollTop,{top:e.top+this.cScrollTop,left:e.left+this.cScrollLeft}}pickedColour(t){var e="wd_DrawColour-"+t;document.getElementById(e).style.borderColor="black"}}
